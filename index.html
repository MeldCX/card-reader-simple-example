<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MeldCX AgentM: Card Reader Simplified RFID Interface</title>

    <!-- Include our MeldCX Agent Library 🤣! -->
    <script src="https://storage.googleapis.com/assets.meld.cx/agent/1.0.18/Agent.js"></script>

    <!-- I am just here to make the code examples look pretty 😉 -->
    <link rel="stylesheet" href="prism.css">
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }
    </style>
    
    <!-- JQuery and Toast 🍞 😀 -->
    <link rel="stylesheet" href="jquery.toast.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="jquery.toast.min.js"></script>
</head>
<body>
    <fieldset>
        <legend>MeldCX AgentM: Card Reader Simplified RFID Interface</legend>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); grid-gap: 10px; text-align: left;">
                <div>
                    <button>Toggle Lock</button>
                </div>
                <div>Lock State is: <strong class="lockState">Unknown</strong>&nbsp;<button>Get Lock State</button></div>
                <div>
                    <pre><code class="language-js">// Lock the latch
window.Agent.onReadyAsync()
.then(() => window.Agent)
.then(agent => agent.RFID.lock())
.then(() => console.log('Locked'))
.catch(ex => {
    console.error('Failed to Lock');
    console.error(ex);
});

// Unlock the latch
window.Agent.onReadyAsync()
.then(() => window.Agent)
.then(agent => agent.RFID.unlock())
.then(() => console.log('Unlocked'))
.catch(ex => {
    console.error('Failed to Unlock');
    console.error(ex);
});</code></pre>
                </div>
                <div>
                    <pre><code class="language-js">// Query lock state
window.Agent.onReadyAsync()
.then(() => window.Agent)
.then(agent => agent.RFID.isLocked())
.then(isLocked => console.log(
    isLocked 
        ? 'The latch is locked'
        : 'The latch is not locked'))
.catch(ex => {
    console.error('Failed to query lock state');
    console.error(ex);
});</code></pre>
                </div>
                <div>
                    &nbsp;
                </div>
                <div>
                    Card is <strong class="cardState">Unknown</strong>&nbsp;<button>Query Card Present</button>
                </div>
                <div>
                    &nbsp;
                </div>
                <div>
                    <pre><code class="language-js">// Query Card Present
window.Agent.onReadyAsync()
.then(() => window.Agent)
.then(agent => agent.RFID.isCardPresent())
.then(isCardPresent => console.log(
    isCardPresent 
        ? 'The card is present'
        : 'The card is not present'))
.catch(ex => {
    console.error('Failed to query card state');
    console.error(ex);
});</code></pre>
                </div>
                <div>
                    <button>Read</button>
                </div>
                <div>
                    <table border="1">
                        <tbody>
                            <tr>
                                <td width="25%"><b>Type</b></td>
                                <td><strong></strong></td>
                            </tr>
                            <tr>
                                <td><b>Capacity</b></td>
                                <td><strong></strong></td>
                            </tr>
                            <tr>
                                <td><b>NUID</b></td>
                                <td><strong></strong></td>
                            </tr>
                            <tr>
                                <td><b>UID</b></td>
                                <td><strong></strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="grid-column: span 2; text-align: center; border: 1px solid black;">
                    <table border="1" width="100%">
                        <thead>
                            <tr>
                                <th>Sector</th>
                                <th>Block</th>
                                <th>0x00 - 0x0F</th>
                                <th>0x10 - 0x1F</th>
                                <th colspan="4">Access</th>
                            </tr>
                        </thead>
                        <tbody class="dataBody">

                        </tbody>
                    </table>
                </div>
                <div>
                        <pre><code class="language-js">//Read Data from Card
window.Agent.onReadyAsync()
.then(() => window.Agent)
.then(agent => agent.RFID.read([
    {
        index: 0,
        keys: { a: [0, 0, 0, 0, 0, 0] }
    }
]))
.then(result => {
    console.log('NUID', result.nuid);
    console.log('UID', result.uid);
    console.log('Capacity', result.capacity);

    console.log('Sectors');
    for (const sector of result.payload.sectors) {
        console.log('\tSector', sector.index);
        console.log('\t\tBlocks:');
    
        for (const block of sector.blocks) {
            console.log(
                '\t\t\tBlock',
                block.index,
                block.type,
                JSON.stringify(block.data),
                JSON.stringify(block.access));
        }
    }
})
.catch(ex => {
    console.error('Failed to read card data');
    console.error(ex);
});</code></pre>
            </div>
            <div></div>
            <div>
                <strong>Data</strong>
                <div class="inputdataFields">
    
                </div>
                <br/>
                <strong>Key A</strong>
                <div class="inputkeyAFields">
    
                </div>
                <br/>
                <strong>Key B</strong>
                <div class="inputkeyBFields">
    
                </div>
            </div>
            <div>
                <label for="sector">Sector</label>
                <select name="sector" disabled></select>
                &nbsp;
                <label for="block">Block</label>
                <select name="block" disabled></select>
                &nbsp;
                <button>Write</button>
            </div>
            <div>
                    <pre><code class="language-js">// Write Data to Card
window.Agent.onReadyAsync()
.then(() => window.Agent)
.then(agent => agent.RFID.write({
    sectors: [
        {
            index: 1,
            keys: { a: [0, 0, 0, 0, 0, 0] },
            blocks: [
                { index: 0, data: [4,3,2,1] }
            ]
        }
    ]
}))
.then(() => console.log('Wrote to card successfully'))
.catch(ex => {
    console.error('Failed to read card data');
    console.error(ex);
});</code></pre>
            </div>
            <div></div>
        </div>
    </fieldset>
    <script>
        const [btnToggleLock, btnGetLockState, btnGetCardState, btnRead, btnWrite] = document.querySelectorAll('button');
        const [strIsLocked, strCardState, strType, strCapacity, strNUID, strUID] = document.querySelectorAll('strong');
        const [lstSector, lstBlock] = document.querySelectorAll('select');
        const dataBody = document.querySelector('.dataBody');

        let lockedState = null;

        const renderData = data => {
            strType.textContent = data.type;
            strCapacity.textContent = data.capacity;
            strUID.textContent = data.uid;
            strNUID.textContent = data.nuid;

            dataBody.innerHTML = '';

            for (const sector of data.payload.sectors) {
                for (const block of sector.blocks) {
                    const tr = document.createElement('tr');
                    const [tdSec, tdBlk, tdData1, tdData2, tdAccess] = Array.from({length: 5}).map(() => document.createElement('td'));
    
                    tdSec.textContent = sector.index;
                    tdBlk.textContent = block.index;

                    tdData1.textContent = block.data.slice(0, 8).map(i => '00'.slice(i.toString(16).length) + i.toString(16).toUpperCase()).join(' ');
                    tdData2.textContent = block.data.slice(8).map(i => '00'.slice(i.toString(16).length) + i.toString(16).toUpperCase()).join(' ');
                    tdAccess.textContent = Object.entries(block.access).reduce((a, [k, v]) => {
                        if (v) a.push(k.toUpperCase().slice(0, 1));

                        return a;
                    }, []).join(' ');

                    tr.appendChild(tdSec);
                    tr.appendChild(tdBlk);
                    tr.appendChild(tdData1);
                    tr.appendChild(tdData2);
                    tr.appendChild(tdAccess);

                    dataBody.appendChild(tr);
                }
            }
        };

        const getLockedState = () => {
            console.log('Get Lock/Latch State');
            window.Agent.onReadyAsync()
                .then(() => window.Agent)
                .then(agent => agent.RFID.isLocked())
                .then(isLocked => {
                    lockedState = isLocked;

                    strIsLocked.textContent = isLocked ? 'Locked' : 'Unlocked';

                    console.log(isLocked 
                        ? 'The latch is locked'
                        : 'The latch is not locked')
                })
                .catch(ex => {
                    console.error('An error occured when getting lock state');
                    console.error(ex);

                    $.toast({
                        text: `<b>Error occured when getting lock status</b><br>${ex.toString().slice(0, 100)}`,
                        bgColor: 'red',
                        textColor: '#000',
                        hideAfter : 15000,
                        icon: 'error'
                    });
                });
        };

        const toggleLock = () => {
            console.log('Toggle Lock');
            window.Agent.onReadyAsync()
                .then(() => window.Agent)
                .then(agent => lockedState ? agent.RFID.unlock() : agent.RFID.lock())
                .then(() => getLockedState())
                .catch(ex => {
                    console.error('An error occured when toggling lock');
                    console.error(ex);

                    $.toast({
                        text: `<b>Error occured when toggling lock</b><br>${ex.toString().slice(0, 100)}`,
                        bgColor: 'red',
                        textColor: '#000',
                        hideAfter : 15000,
                        icon: 'error'
                    });
                });
        };

        const getData = () => {
            console.log('Getting Data');
            window.Agent.onReadyAsync()
                .then(() => window.Agent)
                .then(agent => agent.RFID.read(Array.from({length: 16}).map((_, i) => ({index: i, keys: {a: [0, 0, 0, 0, 0, 0]}}))))
                .then(data => {
                    lstSector.innerHTML = '';
                    lstBlock.innerHTML = '';

                    let sectors = 32;

                    if (data.type === 'MIFARE_CLASSIC_4K') sectors = 39;

                    for (let i = 0; i < sectors; i += 1) {
                        const opt = document.createElement('option');

                        opt.value = i;
                        opt.textContent = i;

                        opt

                        lstSector.appendChild(opt);
                    }

                    lstSector.onchange = () => {
                        lstBlock.innerHTML = '';

                        let blocks = 4;
                        if (i >= 32) {
                            blocks = 16;
                        }

                        for (let b = 0; b < blocks; b += 1) {
                            const bopt = document.createElement('option');

                            bopt.value = b;
                            bopt.textContent = b;

                            lstBlock.appendChild(bopt);
                        }
                    }

                    for (let b = 0; b < 4; b += 1) {
                        const bopt = document.createElement('option');

                        bopt.value = b;
                        bopt.textContent = b;

                        lstBlock.appendChild(bopt);
                    }

                    lstSector.disabled = false;
                    lstBlock.disabled = false;

                    renderData(data);
                })
                .catch (ex => {
                    console.error('An error occured when getting data')
                    $.toast({
                        text: `<b>Error occured when getting card data</b><br>${ex.toString().slice(0, 100)}`,
                        bgColor: 'red',
                        textColor: '#000',
                        hideAfter : 15000,
                        icon: 'error'
                    });
                });
        };

        const writeData = () => {
            const data = [...document.querySelectorAll('.inputdataFields > select')]
                .map(i => i.value).map(i => parseInt(i, 10));

            const a = [...document.querySelectorAll('.inputkeyAFields > select')]
                .map(i => i.value).map(i => parseInt(i, 10));

            const b = [...document.querySelectorAll('.inputkeyBFields > select')]
                .map(i => i.value).map(i => parseInt(i, 10));

            const sector = parseInt(lstSector.value, 10);
            const block = parseInt(lstBlock.value, 10);
            const keys = {a, b};

            window.Agent.onReadyAsync()
                .then(() => window.Agent)
                .then(agent => agent.RFID.write({
                    sectors: [
                        {
                            index: sector,
                            blocks: [
                                {
                                    index: block,
                                    data
                                }
                            ],
                            keys
                        }
                    ]
                }))
                .then(() => {
                    getData();

                    $.toast({
                        text: `<b>Successfully wrote card data</b>`,
                        bgColor: 'green',
                        textColor: '#fff',
                        hideAfter : 15000,
                        icon: 'success'
                    });
                })
                .catch(ex => {
                    console.error('Error occured when writing data');
                    console.error(ex);

                    $.toast({
                        text: `<b>Error occured when getting card state</b><br>${ex.toString().slice(0, 100)}`,
                        bgColor: 'red',
                        textColor: '#000',
                        hideAfter : 15000,
                        icon: 'error'
                    });
                });
        };

        const getCardState = () => window.Agent.onReadyAsync()
            .then(() => window.Agent)
            .then(agent => agent.RFID.isCardPresent())
            .then(cardPresent => { 
                strCardState.textContent = cardPresent
                    ? 'present'
                    : 'not present'
            })
            .catch(ex => {
                console.error('Error occured when getting card state');
                console.error(ex);
                $.toast({
                    text: '<b>Error occured when getting card state</b>',
                    bgColor: 'red',
                    textColor: '#000',
                    icon: 'error'
                });
            });

        btnRead.onclick = () => getData();
        btnWrite.onclick = () => writeData();
        btnToggleLock.onclick = () => toggleLock();
        btnGetCardState.onclick = () => getCardState();
        btnGetLockState.onclick = () => getLockedState();

        getLockedState();
        getCardState();
        getData();

        const inputdataFields = document.querySelector('.inputdataFields');

        for (let i = 0; i < 16; i += 1) {
            const slct = document.createElement('select');
            slct.classList.add(`input${i}`);

            for (let o = 0; o <= 0xFF; o += 1) {
                const opt = document.createElement('option');
                opt.value = o;
                opt.textContent = '00'.slice(o.toString(16).length) + o.toString(16).toUpperCase();

                slct.appendChild(opt);
            }

            if (i === 8) inputdataFields.appendChild(document.createElement('br'));

            inputdataFields.appendChild(slct);
        }

        const inputkeyAFields = document.querySelector('.inputkeyAFields');

        for (let i = 0; i < 6; i += 1) {
            const slct = document.createElement('select');
            slct.classList.add(`input${i}`);

            for (let o = 0; o <= 0xFF; o += 1) {
                const opt = document.createElement('option');
                opt.value = o;
                opt.textContent = '00'.slice(o.toString(16).length) + o.toString(16).toUpperCase();

                slct.appendChild(opt);
            }

            inputkeyAFields.appendChild(slct);
        }

        const inputkeyBFields = document.querySelector('.inputkeyBFields');

        for (let i = 0; i < 6; i += 1) {
            const slct = document.createElement('select');
            slct.classList.add(`input${i}`);

            for (let o = 0; o <= 0xFF; o += 1) {
                const opt = document.createElement('option');
                opt.value = o;
                opt.textContent = '00'.slice(o.toString(16).length) + o.toString(16).toUpperCase();

                slct.appendChild(opt);
            }

            inputkeyBFields.appendChild(slct);
        }
    </script>

    <!-- I am just here to make the code examples look pretty 🦄 -->
    <script src="prism.js"></script>
    <br>
    &copy;&nbsp;MeldCX Pty Ltd 2019
</body>
</html>